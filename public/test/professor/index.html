<!doctype html><html lang="pt-br"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Teste - Inserção de Professor</title><link rel="stylesheet" href="/test/gestor/assets/styles.css"></head><body><button id="theme-toggle" class="theme-toggle btn secondary">Tema</button><div class="wrap"><div class="progress"><div class="step"><div class="dot active"></div><span class="muted">Login</span></div><div class="step"><div class="dot"></div><span class="muted">Modalidade</span></div><div class="step"><div class="dot"></div><span class="muted">Faixa & Grau</span></div><div class="step"><div class="dot"></div><span class="muted">Criar</span></div><div class="step"><div class="dot"></div><span class="muted">Atualizar</span></div></div><div class="card"><h2 class="title">Passo 1 — Verificar Login</h2><div class="row"><div><label>Usuário<input id="pf-user" readonly></label><label>Nome<input id="pf-nome"></label><label>Telefone<input id="pf-tel"></label><label>Nascimento<input id="pf-nasc" type="date"></label></div><div><div class="muted">Confirme que está logado e ajuste os dados básicos se desejar.</div></div></div><div class="nav"><button class="btn" id="btn-login-ok">Continuar</button></div><div id="status" class="status muted"></div></div><div class="card"><h2 class="title">Passo 2 — Selecionar Modalidade</h2><label>Modalidade<select id="pf-mod"></select></label><div class="nav"><button class="btn secondary" id="voltar1">Voltar</button><button class="btn" id="btn-mod-ok">Continuar</button></div></div><div class="card"><h2 class="title">Passo 3 — Selecionar Faixa e Grau</h2><div class="row"><div><label>Faixa<select id="pf-faixa"></select></label><label>Grau<select id="pf-grau"></select></label></div><div><div class="muted">Grau é o subnível dentro da faixa selecionada.</div></div></div><div class="nav"><button class="btn secondary" id="voltar2">Voltar</button><button class="btn" id="btn-faixa-ok">Continuar</button></div></div><div class="card"><h2 class="title">Passo 4 — Criar Perfil de Professor</h2><div class="row"><div><button class="btn" id="btn-criar">Criar Professor</button></div><div><div class="muted">Cria o perfil de professor vinculado ao gestor logado.</div></div></div><div class="nav"><button class="btn secondary" id="voltar3">Voltar</button><button class="btn" id="btn-criar-ok">Continuar</button></div></div><div class="card"><h2 class="title">Passo 5 — Atualizar Dados do Professor</h2><div class="row"><div><label>Foto URL<input id="pf-foto"></label><label>Enviar Foto<input id="pf-file" type="file" accept="image/*"></label></div><div><div class="muted">Opcional: envia/atualiza informações adicionais do perfil.</div></div></div><div class="nav"><button class="btn secondary" id="voltar4">Voltar</button><button class="btn" id="btn-salvar">Salvar</button></div><pre id="res" class="muted"></pre></div><div id="toast" class="toast" style="display:none"></div><script type="module">import{request,toast,setStatus,applyTheme,toggleTheme,ensureTokenOrRedirect}from'/test/gestor/assets/api.js';applyTheme();document.getElementById('theme-toggle').onclick=toggleTheme;ensureTokenOrRedirect();const dots=document.querySelectorAll('.dot');function setStep(i){dots.forEach((d,idx)=>{d.className='dot'+(idx===i?' active':'')})}async function prefillLogin(){const me=await request('GET','/api/auth/me');const u=document.getElementById('pf-user');const n=document.getElementById('pf-nome');u.value=(me?.data?.email)||'';n.value=(me?.data?.nome)||''}async function loadModalidades(){const r=await request('GET','/api/gestor/modalidades/base');const sel=document.getElementById('pf-mod');sel.innerHTML='';(r.data||[]).forEach(m=>{const o=document.createElement('option');o.value=m._id;o.textContent=m.nome;sel.appendChild(o)});if(!sel.value){const o=document.createElement('option');o.value='';o.textContent='Selecione';sel.appendChild(o);sel.value=''} }async function loadFaixas(){const mod=document.getElementById('pf-mod').value;const sel=document.getElementById('pf-faixa');sel.innerHTML='';document.getElementById('pf-grau').innerHTML='';if(!mod){const o=document.createElement('option');o.value='';o.textContent='Selecione modalidade';sel.appendChild(o);return}const rr=await request('GET','/api/niveis/'+mod);const list=(rr.data||[]).slice().sort((a,b)=>Number(a.ordem||0)-Number(b.ordem||0)||String(a.nome||'').localeCompare(String(b.nome||'')));if(list.length===0){const o=document.createElement('option');o.value='';o.textContent='Sem faixas';sel.appendChild(o)}else{const p=document.createElement('option');p.value='';p.textContent='Selecione faixa';sel.appendChild(p);list.forEach(n=>{const o=document.createElement('option');o.value=n._id;o.textContent=n.nome;sel.appendChild(o)})}}function populateGrau(){const gid=(document.getElementById('pf-faixa').value||'');const sel=document.getElementById('pf-grau');sel.innerHTML='';if(!gid){const o=document.createElement('option');o.value='';o.textContent='Selecione faixa';sel.appendChild(o);return}const mod=document.getElementById('pf-mod').value;if(!mod){const o=document.createElement('option');o.value='';o.textContent='Selecione modalidade';sel.appendChild(o);return}request('GET','/api/niveis/'+mod).then(rr=>{const list=(rr.data||[]);const n=list.find(x=>String(x._id)===String(gid));let max=0;const g=(n?.graus)||[];if(Array.isArray(g)&&g.length>0){max=g.reduce((m,x)=>Math.max(m,Number(x.numero||0)),0)}for(let i=0;i<=max;i++){const o=document.createElement('option');o.value=String(i);o.textContent=String(i);sel.appendChild(o)}})}document.getElementById('pf-faixa').onchange=populateGrau;document.getElementById('btn-login-ok').onclick=()=>{setStep(1)};document.getElementById('voltar1').onclick=()=>{setStep(0)};document.getElementById('btn-mod-ok').onclick=()=>{setStep(2)};document.getElementById('voltar2').onclick=()=>{setStep(1)};document.getElementById('btn-faixa-ok').onclick=()=>{setStep(3)};document.getElementById('voltar3').onclick=()=>{setStep(2)};document.getElementById('voltar4').onclick=()=>{setStep(3)};document.getElementById('btn-criar').onclick=async()=>{const r=await request('POST','/api/gestor/professor');setStatus(r.res.ok,'Criar: '+r.res.status);const data=r.data||{};const pre=document.getElementById('res');pre.textContent=JSON.stringify(data);if(r.res.ok){setStep(4)}};document.getElementById('btn-criar-ok').onclick=()=>{setStep(4)};document.getElementById('btn-salvar').onclick=async()=>{const pre=document.getElementById('res');let perfilId=null;try{const parsed=JSON.parse(pre.textContent||'{}');perfilId=(parsed?.perfil?._id)||parsed?.perfilProfessorId||null}catch(e){perfilId=null}if(!perfilId){toast('Crie o professor primeiro');return}const nome=(document.getElementById('pf-nome').value||'').trim();const telefone=(document.getElementById('pf-tel').value||'').trim();const nascimento=(document.getElementById('pf-nasc').value||'').trim();const fotoUrl=(document.getElementById('pf-foto').value||'').trim();const modalidadeId=document.getElementById('pf-mod').value||null;const faixaId=document.getElementById('pf-faixa').value||null;const grauSel=document.getElementById('pf-grau').value||null;let fotoBase64=null;const file=document.getElementById('pf-file').files?.[0]||null;if(file){fotoBase64=await new Promise(resolve=>{const fr=new FileReader();fr.onload=()=>resolve(String(fr.result));fr.readAsDataURL(file)})}const body={};if(nome)body.nome=nome;if(telefone)body.telefone=telefone;if(nascimento)body.nascimento=nascimento;if(fotoUrl)body.fotoUrl=fotoUrl;if(fotoBase64)body.fotoBase64=fotoBase64;if(modalidadeId)body.modalidadeId=modalidadeId;if(faixaId)body.faixaId=faixaId;if(grauSel)body.graus=Number(grauSel);const upd=await request('PATCH','/api/perfis/'+perfilId,body);setStatus(upd.res.ok,'Atualizar: '+upd.res.status);pre.textContent=JSON.stringify({criado:JSON.parse(pre.textContent||'{}'), atualizado:upd.data})};(async()=>{await prefillLogin();await loadModalidades();await loadFaixas();setStep(0)})()</script></body></html>