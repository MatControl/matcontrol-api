<!doctype html><html lang="pt-br"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Professor — Passo 4 (Luta)</title><link rel="stylesheet" href="/test/gestor/assets/styles.css"></head><body><button id="theme-toggle" class="theme-toggle btn secondary">Tema</button><div class="wrap"><div class="progress"><div class="step"><div class="dot"></div><span class="muted">Cadastro</span></div><div class="step"><div class="dot"></div><span class="muted">Login</span></div><div class="step"><div class="dot"></div><span class="muted">Dados</span></div><div class="step"><div class="dot active"></div><span class="muted">Luta</span></div><div class="step"><div class="dot"></div><span class="muted">Dashboard</span></div></div><div class="card"><h2 class="title">Dados de Luta</h2><div class="row"><div><label>Modalidade<select id="pf-mod"></select></label><label>Faixa<select id="pf-faixa"></select></label><label>Grau<select id="pf-grau"></select></label><label>Data da última graduação<input id="pf-ultima" type="date"></label></div><div><div class="muted">Selecione sua modalidade, faixa, grau e informe a última graduação.</div></div></div><div class="nav"><button class="btn secondary" id="back">Voltar</button><button class="btn" id="next">Confirmar</button></div><div id="status" class="status muted"></div></div></div><div id="toast" class="toast" style="display:none"></div><script type="module">import{request,applyTheme,toggleTheme,ensureTokenOrRedirect,set,get,setStatus,toast}from'/test/gestor/assets/api.js';applyTheme();document.getElementById('theme-toggle').onclick=toggleTheme;ensureTokenOrRedirect();async function loadModalidades(){const r=await request('GET','/api/gestor/modalidades/base');const sel=document.getElementById('pf-mod');sel.innerHTML='';(r.data||[]).forEach(m=>{const o=document.createElement('option');o.value=m._id;o.textContent=m.nome;sel.appendChild(o)});if(!sel.value){const o=document.createElement('option');o.value='';o.textContent='Selecione';sel.appendChild(o);sel.value=''}}async function loadFaixas(){const mod=document.getElementById('pf-mod').value;const sel=document.getElementById('pf-faixa');sel.innerHTML='';document.getElementById('pf-grau').innerHTML='';if(!mod){const o=document.createElement('option');o.value='';o.textContent='Selecione modalidade';sel.appendChild(o);return}const rr=await request('GET','/api/niveis/'+mod);const list=(rr.data||[]).slice().sort((a,b)=>Number(a.ordem||0)-Number(b.ordem||0)||String(a.nome||'').localeCompare(String(b.nome||'')));if(list.length===0){const o=document.createElement('option');o.value='';o.textContent='Sem faixas';sel.appendChild(o)}else{const p=document.createElement('option');p.value='';p.textContent='Selecione faixa';sel.appendChild(p);list.forEach(n=>{const o=document.createElement('option');o.value=n._id;o.textContent=n.nome;sel.appendChild(o)})}}function populateGrau(){const gid=(document.getElementById('pf-faixa').value||'');const sel=document.getElementById('pf-grau');sel.innerHTML='';if(!gid){const o=document.createElement('option');o.value='';o.textContent='Selecione faixa';sel.appendChild(o);return}const mod=document.getElementById('pf-mod').value;request('GET','/api/niveis/'+mod).then(rr=>{const list=(rr.data||[]);const n=list.find(x=>String(x._id)===String(gid));let max=0;const g=(n?.graus)||[];if(Array.isArray(g)&&g.length>0){max=g.reduce((m,x)=>Math.max(m,Number(x.numero||0)),0)}for(let i=0;i<=max;i++){const o=document.createElement('option');o.value=String(i);o.textContent=String(i);sel.appendChild(o)}})}async function getProfessorPerfilId(){const perf=await request('GET','/api/perfis/user');const arr=perf?.data||[];const p=(Array.isArray(arr)?arr:[]).find(x=>String(x.tipo).toLowerCase()==='professor');return p?String(p._id):null}document.getElementById('pf-mod').onchange=loadFaixas;document.getElementById('pf-faixa').onchange=populateGrau;document.getElementById('back').onclick=()=>{location.href='/test/professor/dados.html'};document.getElementById('next').onclick=async()=>{const mod=document.getElementById('pf-mod').value||'';const faixa=document.getElementById('pf-faixa').value||'';const grau=document.getElementById('pf-grau').value||'';const ultima=(document.getElementById('pf-ultima').value||'').trim();if(!mod||!faixa){alert('Selecione modalidade e faixa');return}set('prof_mod',mod);set('prof_faixa',faixa);set('prof_grau',grau||'0');if(ultima)set('prof_ultima',ultima);const perfilId=await getProfessorPerfilId();if(!perfilId){toast('Perfil de professor não encontrado');return}const body={};body.modalidadeId=mod;body.faixaId=faixa;if(grau)body.graus=Number(grau);if(ultima)body.ultimaGraduacao=ultima;const upd=await request('PATCH','/api/perfis/'+perfilId,body);setStatus(upd.res.ok,'Luta: '+upd.res.status);if(upd.res.ok){location.href='/test/professor/dashboard.html'}};(async()=>{await loadModalidades();await loadFaixas()})();</script></body></html>