<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Checkout</title>
  <link rel="stylesheet" href="/test/gestor/assets/styles.css">
  <script type="module">
    import { request, toast, setStatus, ensureTokenOrRedirect, applyTheme, toggleTheme, resumeOnPageLoad } from '/test/gestor/assets/api.js'
    applyTheme()
    window.addEventListener('DOMContentLoaded',()=>{ document.getElementById('theme-toggle').onclick = toggleTheme })
    ensureTokenOrRedirect()
    resumeOnPageLoad('/test/gestor/checkout')
    const getPlatformPrices = async () => { const r = await request('GET','/api/pagamentos/plataforma/precos'); return r?.res?.ok ? (r?.data || {}) : {} }
    const populateTierSelect = (prices) => { const sel = document.getElementById('tier'); if (!sel) return; sel.innerHTML=''; ['basico','intermediario','avancado'].forEach(k=>{ const p=prices[k]; if(p){ const opt=document.createElement('option'); opt.value=k; const name=(p.name||k).replace('Plano ',''); opt.textContent=`${name} - R$ ${Number(p.amount).toFixed(2)}`; sel.appendChild(opt) } }) }
    const subscribeStripe = async () => { const tierSel = (document.getElementById('tier')?.value || '').toLowerCase(); const r = await request('POST','/api/billing/subscribe',{ tier: tierSel }); if(r.res.ok && r.data && r.data.url){ setStatus(true,'Redirecionando para Stripe'); location.href = r.data.url } else { const msg = (r.data && (r.data.mensagem || r.data.error || r.data.erro || r.data.detalhes)) || ('Falha ao iniciar Stripe: '+r.res.status); setStatus(false, msg); const el=document.getElementById('pay-res'); if(el) el.textContent = JSON.stringify(r.data) } }
    (async()=>{ const prices=await getPlatformPrices(); populateTierSelect(prices); document.getElementById('pay-res').textContent='' })()
    document.getElementById('btn-subscribe').onclick = subscribeStripe
  </script>
</head>
<body>
  <button id="theme-toggle" class="theme-toggle btn secondary">Tema</button>
  <div class="wrap">
    <div class="progress">
      <div class="step"><div class="dot"></div><span class="muted">Cadastro</span></div>
      <div class="step"><div class="dot"></div><span class="muted">Login</span></div>
      <div class="step"><div class="dot"></div><span class="muted">Academia</span></div>
      <div class="step"><div class="dot"></div><span class="muted">Modalidades</span></div>
      <div class="step"><div class="dot"></div><span class="muted">Planos</span></div>
      <div class="step"><div class="dot"></div><span class="muted">Professor</span></div>
      <div class="step"><div class="dot active"></div><span class="muted">Checkout</span></div>
    </div>
    <div class="card">
      <h2 class="title">Checkout da Plataforma</h2>
      <label>Tier
        <select id="tier">
          <option value="basico">Basico</option>
          <option value="intermediario">Intermediario</option>
          <option value="avancado">Avancado</option>
        </select>
      </label>
      <div class="nav"><button class="btn secondary" onclick="location.href='/test/gestor/professor'">Voltar</button></div>
      <div id="status" class="status muted"></div>
    </div>
    <div class="card">
      <div class="nav"><button id="btn-subscribe" class="btn">Assinar com Stripe</button></div>
      <div class="muted" id="pay-res"></div>
    </div>
  </div>
  <div id="toast" class="toast" style="display:none"></div>
</body>
</html>