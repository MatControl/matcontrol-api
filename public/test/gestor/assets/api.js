const IS_PROF=(()=>{try{return String(location?.pathname||'').includes('/test/professor')}catch(e){return false}})()
const IS_ALUNO=(()=>{try{return String(location?.pathname||'').includes('/test/aluno')}catch(e){return false}})()
const KEYS={
  token: IS_PROF?'prof_token':(IS_ALUNO?'aluno_token':'gestor_token'),
  acad: IS_PROF?'prof_academia_id':(IS_ALUNO?'aluno_academia_id':'gestor_academia_id'),
  email: IS_PROF?'prof_email':(IS_ALUNO?'aluno_email':'gestor_email'),
  senha: IS_PROF?'prof_senha':(IS_ALUNO?'aluno_senha':'gestor_senha'),
  theme: IS_PROF?'prof_theme':(IS_ALUNO?'aluno_theme':'gestor_theme')
}
let FLOW_REDIRECTING=false;function safeRedirect(to){try{if(FLOW_REDIRECTING)return;FLOW_REDIRECTING=true;location.href=to}catch(e){FLOW_REDIRECTING=false;return}}
try{console.log('api-init',{href:location?.href});window.addEventListener('error',e=>{console.log('page-error',{message:e?.message,src:e?.filename,line:e?.lineno,col:e?.colno})});window.addEventListener('unhandledrejection',e=>{console.log('unhandled-rejection',{reason:String(e?.reason||'')})})}catch(e){console.log('api-init:error',String(e?.message||e))}
async function isPagamentoConcluido(academia){try{const acadId=(academia?._id)||academia?.id||academia?.academiaId||null;const statusPago=String(academia?.statusPagamento||'').toLowerCase()==='ativo';const temStripe=Boolean(academia?.stripeSubscriptionId);if(statusPago||temStripe)return true;if(!acadId)return true;let confirmado=false;let nega=false;const cfg=await request('GET','/api/pagamentos/academias/'+acadId+'/config');if(cfg.res.ok){const d=cfg.data||{};const ativo=Boolean(d.assinaturaAtiva)||Boolean(d.stripeSubscriptionId)||String(d.statusPagamento||'').toLowerCase()==='ativo';confirmado=confirmado||ativo;const inativo=String(d.statusPagamento||'').toLowerCase()==='inativo';nega=nega||inativo}const lp=await request('GET','/api/pagamentos/academias/'+acadId);if(lp.res.ok){const list=Array.isArray(lp.data)?lp.data:[];if(list.some(x=>String(x.status||'')==='pago'))confirmado=true}if(confirmado)return true;if(nega)return false;return true}catch(e){return true}}
async function resumeAfterLogin(){if(FLOW_REDIRECTING)return;console.log('resume-after-login:start');let d='/test/gestor/academia';const acad=await request('GET','/api/gestor/academia');if(!acad.res.ok){console.log('resume-after-login:redirect',{to:d});safeRedirect(d);return}const a=acad.data||{};if(!Array.isArray(a.modalidadesAtivas)||a.modalidadesAtivas.length===0){console.log('resume-after-login:redirect',{to:'/test/gestor/modalidades'});safeRedirect('/test/gestor/modalidades');return}const pl=await request('GET','/api/gestor/planos');let temPlanos=false;if(pl.data&&Array.isArray(pl.data.planos)){temPlanos=pl.data.planos.length>0}else if(Array.isArray(pl.data)){temPlanos=pl.data.length>0}if(!temPlanos){console.log('resume-after-login:redirect',{to:'/test/gestor/planos'});safeRedirect('/test/gestor/planos');return}const perf=await request('GET','/api/perfis/user');const temProfessor=Array.isArray(perf.data)&&perf.data.some(p=>String(p.tipo).toLowerCase()==='professor');if(!temProfessor){console.log('resume-after-login:redirect',{to:'/test/gestor/professor'});safeRedirect('/test/gestor/professor');return}const okPagamento=await isPagamentoConcluido(a);if(!okPagamento){console.log('resume-after-login:redirect',{to:'/test/gestor/checkout'});safeRedirect('/test/gestor/checkout');return}console.log('resume-after-login:redirect',{to:'/test/gestor/dashboard'});safeRedirect('/test/gestor/dashboard')}
async function computeNextStep(){console.log('compute-next:start');let d='/test/gestor/academia';const acad=await request('GET','/api/gestor/academia');if(!acad.res.ok){console.log('compute-next:dest',{dest:d});return d}const a=acad.data||{};if(!Array.isArray(a.modalidadesAtivas)||a.modalidadesAtivas.length===0){console.log('compute-next:dest',{dest:'/test/gestor/modalidades'});return'/test/gestor/modalidades'}const pl=await request('GET','/api/gestor/planos');let temPlanos=false;if(pl.data&&Array.isArray(pl.data.planos)){temPlanos=pl.data.planos.length>0}else if(Array.isArray(pl.data)){temPlanos=pl.data.length>0}if(!temPlanos){console.log('compute-next:dest',{dest:'/test/gestor/planos'});return'/test/gestor/planos'}const perf=await request('GET','/api/perfis/user');const temProfessor=Array.isArray(perf.data)&&perf.data.some(p=>String(p.tipo).toLowerCase()==='professor');if(!temProfessor){console.log('compute-next:dest',{dest:'/test/gestor/professor'});return'/test/gestor/professor'}const okPagamento=await isPagamentoConcluido(a);console.log('compute-next:checkout',{okPagamento});if(!okPagamento){console.log('compute-next:dest',{dest:'/test/gestor/checkout'});return'/test/gestor/checkout'}console.log('compute-next:dest',{dest:'/test/gestor/dashboard'});return'/test/gestor/dashboard'}
function resumeOnPageLoad(current){if(FLOW_REDIRECTING)return;computeNextStep().then(dest=>{try{console.log('resume-on-load',{current,dest});if(dest&&current!==dest){console.log('resume-on-load:redirect',{to:dest});safeRedirect(dest)}}catch(e){console.log('resume-on-load:error',String(e?.message||e));return}})}
function set(k,v){try{localStorage.setItem(k,String(v||''));if(k===KEYS.token&&v&&!IS_PROF){resumeAfterLogin()}}catch(e){return}}
function get(k){try{return localStorage.getItem(k)||''}catch{return ''}}
function clear(k){try{localStorage.removeItem(k)}catch(e){return}}
function authHeader(){const t=get(KEYS.token);return t?{Authorization:'Bearer '+t}:{}}
async function request(method,url,body){const opts={method,headers:{'Content-Type':'application/json',...authHeader()}};if(body)opts.body=JSON.stringify(body);const res=await fetch(url,opts);let data={};try{data=await res.json()}catch(e){data={}}return{res,data}}
function toast(msg){let el=document.getElementById('toast');if(!el){el=document.createElement('div');el.id='toast';el.className='toast';document.body.appendChild(el)}el.textContent=msg;el.style.display='block';setTimeout(()=>{el.style.display='none'},2500)}
function setStatus(ok,msg){const el=document.getElementById('status');if(!el)return;el.textContent=msg;el.style.color=ok?'#10b981':'#ef4444'}
function stepDots(active){const dots=document.querySelectorAll('.dot');dots.forEach((d,i)=>{d.className='dot'+(i===active?' active':'')})}
function ensureTokenOrRedirect(){const t=get(KEYS.token);if(!t){const to=IS_PROF?'/test/professor/login.html':(IS_ALUNO?'/test/aluno/login.html':'/test/gestor/login');console.log('ensure-token:redirect',{to});location.href=to}else{console.log('ensure-token:ok')}}
function ensureAcademiaOrRedirect(){if(!get(KEYS.acad)){location.href='/test/gestor/academia'}}
function saveCreds(email,senha){set(KEYS.email,email);set(KEYS.senha,senha)}
function prefillCreds(){const e=document.getElementById('email');const s=document.getElementById('senha');if(e)e.value=get(KEYS.email)||'';if(s)s.value=get(KEYS.senha)||''}
export{KEYS,set,get,clear,authHeader,request,toast,setStatus,stepDots,ensureTokenOrRedirect,ensureAcademiaOrRedirect,saveCreds,prefillCreds,computeNextStep,resumeOnPageLoad}
function setTokenSilently(t){try{localStorage.setItem(KEYS.token,String(t||''))}catch(e){return}}
export{setTokenSilently}
function applyTheme(){const t=get(KEYS.theme)||'dark';const b=document.body;b.classList.remove('light');if(t==='light')b.classList.add('light')}
function toggleTheme(){const cur=get(KEYS.theme)||'dark';const next=cur==='light'?'dark':'light';set(KEYS.theme,next);applyTheme()}
export{applyTheme,toggleTheme}
try{if(String(location?.pathname||'').includes('/test/gestor/professor')){window.addEventListener('DOMContentLoaded',()=>{const pfNome=document.getElementById('pf-nome');request('GET','/api/auth/me').then(me=>{const n=me?.data?.nome||'';if(pfNome&&n)pfNome.value=n}).catch(e=>{console.log('prefill-nome:error',String(e?.message||e))});function ensureGrau(){let g=document.getElementById('pf-grau');if(!g){const lab=document.createElement('label');lab.textContent='Grau';g=document.createElement('select');g.id='pf-grau';lab.appendChild(g);const faixa=document.getElementById('pf-faixa');if(faixa&&faixa.parentNode)faixa.parentNode.insertAdjacentElement('afterend',lab)}}async function populateGrau(){ensureGrau();const sel=document.getElementById('pf-grau');if(!sel)return;sel.innerHTML='';const mod=(document.getElementById('pf-mod')?.value||'');const faixa=(document.getElementById('pf-faixa')?.value||'');if(!mod||!faixa){const o=document.createElement('option');o.value='';o.textContent='Selecione faixa';sel.appendChild(o);return}const rr=await request('GET','/api/niveis/'+mod);const list=(rr.data||[]);const n=list.find(x=>String(x._id)===String(faixa));let max=0;const g=(n?.graus)||[];if(Array.isArray(g)&&g.length>0){max=g.reduce((m,x)=>Math.max(m,Number(x.numero||0)),0)}for(let i=0;i<=max;i++){const o=document.createElement('option');o.value=String(i);o.textContent=String(i);sel.appendChild(o)}}const pfFaixa=document.getElementById('pf-faixa');if(pfFaixa)pfFaixa.addEventListener('change',populateGrau);const btn=document.getElementById('submit');if(btn)btn.onclick=async()=>{const go=document.getElementById('chk')?.checked||false;if(!go){location.href='/test/gestor/checkout';return}const r=await request('POST','/api/gestor/professor');setStatus(r.res.ok,'Professor: '+r.res.status);const data=r.data||{};let perfilId=(data?.perfil?._id)||null;perfilId=perfilId||data?.perfil?.id||null;perfilId=perfilId||data?.perfilProfessorId||null;if(!perfilId){toast('Perfil de professor nÃ£o identificado');const pre=document.getElementById('res');if(pre)pre.textContent=JSON.stringify(data);return}const nome=(document.getElementById('pf-nome')?.value||'').trim();const telefone=(document.getElementById('pf-tel')?.value||'').trim();const nascimento=(document.getElementById('pf-nasc')?.value||'').trim();const fotoUrl=(document.getElementById('pf-foto')?.value||'').trim();const modalidadeId=document.getElementById('pf-mod')?.value||null;const faixaId=document.getElementById('pf-faixa')?.value||null;const grauSel=document.getElementById('pf-grau')?.value||null;let fotoBase64=null;const file=document.getElementById('pf-file')?.files?.[0]||null;if(file){fotoBase64=await new Promise(resolve=>{const fr=new FileReader();fr.onload=()=>resolve(String(fr.result));fr.readAsDataURL(file)})}const body={};if(nome)body.nome=nome;if(telefone)body.telefone=telefone;if(nascimento)body.nascimento=nascimento;if(fotoUrl)body.fotoUrl=fotoUrl;if(fotoBase64)body.fotoBase64=fotoBase64;if(modalidadeId)body.modalidadeId=modalidadeId;if(faixaId)body.faixaId=faixaId;if(grauSel)body.graus=Number(grauSel);const upd=await request('PATCH','/api/perfis/'+perfilId,body);const pre=document.getElementById('res');if(pre)pre.textContent=JSON.stringify({criado:data,atualizado:upd.data});if(upd.res.ok){toast('Dados do professor salvos')}}})}}catch(e){console.log('init-prof:error',String(e?.message||e))}
