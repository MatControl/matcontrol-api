import{request,toast,setStatus}from'/test/gestor/assets/api.js'
window.addEventListener('DOMContentLoaded',()=>{const pfNome=document.getElementById('pf-nome');request('GET','/api/auth/me').then(me=>{const n=me?.data?.nome||'';if(pfNome&&n)pfNome.value=n}).catch(()=>{0});async function populateGrau(){const sel=document.getElementById('pf-grau');if(!sel)return;sel.innerHTML='';const mod=(document.getElementById('pf-mod')?.value||'');const faixa=(document.getElementById('pf-faixa')?.value||'');if(!mod||!faixa){const o=document.createElement('option');o.value='';o.textContent='Selecione faixa';sel.appendChild(o);return}const rr=await request('GET','/api/niveis/'+mod);const list=(rr.data||[]);const n=list.find(x=>String(x._id)===String(faixa));let max=0;const g=(n?.graus)||[];if(Array.isArray(g)&&g.length>0){max=g.reduce((m,x)=>Math.max(m,Number(x.numero||0)),0)}for(let i=0;i<=max;i++){const o=document.createElement('option');o.value=String(i);o.textContent=String(i);sel.appendChild(o)}}const pfFaixa=document.getElementById('pf-faixa');if(pfFaixa)pfFaixa.addEventListener('change',populateGrau);const btn=document.getElementById('submit');if(btn)btn.onclick=async()=>{const go=document.getElementById('chk')?.checked||false;if(!go){location.href='/test/gestor/checkout';return}const r=await request('POST','/api/gestor/professor');setStatus(r.res.ok,'Professor: '+r.res.status);const data=r.data||{};let perfilId=(data?.perfil?._id)||null;perfilId=perfilId||data?.perfil?.id||null;perfilId=perfilId||data?.perfilProfessorId||null;if(!perfilId){toast('Perfil de professor nÃ£o identificado');const pre=document.getElementById('res');if(pre)pre.textContent=JSON.stringify(data);return}const nome=(document.getElementById('pf-nome')?.value||'').trim();const telefone=(document.getElementById('pf-tel')?.value||'').trim();const nascimento=(document.getElementById('pf-nasc')?.value||'').trim();const fotoUrl=(document.getElementById('pf-foto')?.value||'').trim();const modalidadeId=document.getElementById('pf-mod')?.value||null;const faixaId=document.getElementById('pf-faixa')?.value||null;const grauSel=document.getElementById('pf-grau')?.value||null;let fotoBase64=null;const file=document.getElementById('pf-file')?.files?.[0]||null;if(file){fotoBase64=await new Promise(resolve=>{const fr=new FileReader();fr.onload=()=>resolve(String(fr.result));fr.readAsDataURL(file)})}const body={};if(nome)body.nome=nome;if(telefone)body.telefone=telefone;if(nascimento)body.nascimento=nascimento;if(fotoUrl)body.fotoUrl=fotoUrl;if(fotoBase64)body.fotoBase64=fotoBase64;if(modalidadeId)body.modalidadeId=modalidadeId;if(faixaId)body.faixaId=faixaId;if(grauSel)body.graus=Number(grauSel);const upd=await request('PATCH','/api/perfis/'+perfilId,body);const pre=document.getElementById('res');if(pre)pre.textContent=JSON.stringify({criado:data,atualizado:upd.data});if(upd.res.ok){toast('Dados do professor salvos')}}})