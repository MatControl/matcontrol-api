<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teste Fluxo Gestor</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    h1 { font-size: 20px; }
    section { border: 1px solid #ddd; padding: 16px; margin-bottom: 16px; border-radius: 8px; }
    label { display:block; margin: 6px 0; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 4px; }
    button { padding: 8px 12px; margin-top: 8px; }
    .ok { color: #0a8; }
    .err { color: #d00; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    .muted { color:#666; font-size:12px; }
    .pill { display:inline-block; background:#eef; padding:4px 8px; border-radius:999px; margin:2px; }
  </style>
</head>
<body>
  <h1>Fluxo de Testes do Gestor</h1>
  <div id="status" class="muted">Preencha os campos e siga o fluxo.</div>

  <section>
    <h2>Cadastro</h2>
    <label>Nome <input id="cad-nome" /></label>
    <label>Email <input id="cad-email" /></label>
    <label>Senha <input id="cad-senha" type="password" /></label>
    <button id="btn-cadastrar">Cadastrar Gestor</button>
    <div id="cad-res" class="muted"></div>
  </section>

  <section>
    <h2>Login</h2>
    <label>Email <input id="login-email" /></label>
    <label>Senha <input id="login-senha" type="password" /></label>
    <button id="btn-login">Login</button>
    <div id="login-res" class="muted"></div>
  </section>

  <section>
    <h2>Dados da Academia</h2>
    <div class="row">
      <div>
        <label>Nome da Academia <input id="acad-nome" /></label>
        <label>Telefone <input id="acad-tel" /></label>
        <label>Email <input id="acad-email" /></label>
      </div>
      <div>
        <label>Rua <input id="end-rua" /></label>
        <label>Número <input id="end-num" /></label>
        <label>Cidade <input id="end-cid" /></label>
        <label>Estado <input id="end-uf" /></label>
        <label>CEP <input id="end-cep" /></label>
      </div>
    </div>
    <button id="btn-criar-acad">Cadastrar Academia</button>
    <button id="btn-obter-acad">Obter Minha Academia</button>
    <div id="acad-res" class="muted"></div>
  </section>

  <section>
    <h2>Modalidades</h2>
    <button id="btn-listar-base">Listar Base</button>
    <div id="mods-base" class="muted"></div>
    <label>IDs de Modalidades para ativar (separadas por vírgula)
      <input id="mods-ativar" />
    </label>
    <button id="btn-ativar-mods">Ativar Modalidades</button>
    <div id="mods-res" class="muted"></div>
  </section>

  <section>
    <h2>Planos</h2>
    <label>Nome do Plano <input id="pl-nome" /></label>
    <label>Descrição <input id="pl-desc" /></label>
    <label>Valor <input id="pl-valor" type="number" step="0.01" /></label>
    <label>Modalidades (IDs, vírgulas) <input id="pl-mods" /></label>
    <button id="btn-criar-plano">Criar Plano</button>
    <button id="btn-listar-planos">Listar Meus Planos</button>
    <div id="pl-res" class="muted"></div>
  </section>

  <section>
    <h2>Professor</h2>
    <label><input type="checkbox" id="chk-prof" /> Gestor será professor</label>
    <button id="btn-criar-prof">Criar Perfil de Professor (se marcado)</button>
    <div id="prof-res" class="muted"></div>
  </section>

  <section>
    <h2>Checkout</h2>
    <label>Tier
      <select id="chk-tier">
        <option value="basico">Basico</option>
        <option value="intermediario">Intermediario</option>
        <option value="avancado">Avancado</option>
      </select>
    </label>
    <button id="btn-checkout">Iniciar Checkout</button>
    <div id="chk-res" class="muted"></div>
  </section>

  <script>
    const S = {
      t: null,
      acadId: null,
    }
    function setStatus(msg, ok) {
      const el = document.getElementById('status')
      el.textContent = msg
      el.className = ok ? 'ok' : 'err'
    }
    function authHeader() {
      return S.t ? { 'Authorization': 'Bearer ' + S.t } : {}
    }
    async function request(method, url, body) {
      const opts = { method, headers: { 'Content-Type': 'application/json', ...authHeader() } }
      if (body) opts.body = JSON.stringify(body)
      const res = await fetch(url, opts)
      const data = await res.json().catch(() => ({}))
      return { res, data }
    }
    function pills(list) {
      return (list || []).map(x => '<span class="pill">' + x + '</span>').join(' ')
    }

    document.getElementById('btn-cadastrar').onclick = async () => {
      const nome = document.getElementById('cad-nome').value.trim()
      const email = document.getElementById('cad-email').value.trim()
      const senha = document.getElementById('cad-senha').value.trim()
      const r = await request('POST', '/api/gestor/cadastro', { nome, email, senha })
      document.getElementById('cad-res').textContent = JSON.stringify(r.data)
      setStatus('Cadastro: ' + r.res.status, r.res.ok)
      if (r.res.ok) {
        document.getElementById('login-email').value = email
        document.getElementById('login-senha').value = senha
      }
    }

    document.getElementById('btn-login').onclick = async () => {
      const email = document.getElementById('login-email').value.trim()
      const senha = document.getElementById('login-senha').value.trim()
      const r = await request('POST', '/api/gestor/login', { email, senha })
      document.getElementById('login-res').textContent = JSON.stringify({ status: r.res.status })
      setStatus('Login: ' + r.res.status, r.res.ok)
      if (r.data && r.data.token) S.t = r.data.token
    }

    document.getElementById('btn-criar-acad').onclick = async () => {
      const nome = document.getElementById('acad-nome').value.trim()
      const telefone = document.getElementById('acad-tel').value.trim()
      const email = document.getElementById('acad-email').value.trim()
      const endereco = {
        rua: document.getElementById('end-rua').value.trim(),
        numero: document.getElementById('end-num').value.trim(),
        cidade: document.getElementById('end-cid').value.trim(),
        estado: document.getElementById('end-uf').value.trim(),
        cep: document.getElementById('end-cep').value.trim(),
      }
      const r = await request('POST', '/api/gestor/academia', { nome, telefone, email, endereco })
      document.getElementById('acad-res').textContent = JSON.stringify(r.data)
      setStatus('Academia: ' + r.res.status, r.res.ok)
      const id = r?.data?.academia?._id || null
      if (id) S.acadId = id
    }

    document.getElementById('btn-obter-acad').onclick = async () => {
      const r = await request('GET', '/api/gestor/academia')
      document.getElementById('acad-res').textContent = JSON.stringify(r.data)
      setStatus('Obter academia: ' + r.res.status, r.res.ok)
      const id = r?.data?._id || null
      if (id) S.acadId = id
    }

    document.getElementById('btn-listar-base').onclick = async () => {
      const r = await request('GET', '/api/gestor/modalidades/base')
      const list = (r.data || []).map(m => m._id + ' ' + m.nome).join('\n')
      document.getElementById('mods-base').textContent = list
      setStatus('Modalidades base: ' + r.res.status, r.res.ok)
    }

    document.getElementById('btn-ativar-mods').onclick = async () => {
      const raw = document.getElementById('mods-ativar').value.trim()
      const modalidades = raw ? raw.split(',').map(s => s.trim()).filter(Boolean) : []
      const body = S.acadId ? { academiaId: S.acadId, modalidades } : { modalidades }
      const r = await request('POST', '/api/gestor/modalidades/ativar', body)
      document.getElementById('mods-res').innerHTML = 'Ativas: ' + pills(r?.data?.modalidadesAtivas)
      setStatus('Ativar modalidades: ' + r.res.status, r.res.ok)
    }

    document.getElementById('btn-criar-plano').onclick = async () => {
      const nome = document.getElementById('pl-nome').value.trim()
      const descricao = document.getElementById('pl-desc').value.trim()
      const valor = Number(document.getElementById('pl-valor').value)
      const mods = document.getElementById('pl-mods').value.trim()
      const modalidadesDisponiveis = mods ? mods.split(',').map(s => s.trim()).filter(Boolean) : []
      const body = { nome, descricao, valor, modalidadesDisponiveis }
      const r = await request('POST', '/api/gestor/planos', body)
      document.getElementById('pl-res').textContent = JSON.stringify(r.data)
      setStatus('Criar plano: ' + r.res.status, r.res.ok)
    }

    document.getElementById('btn-listar-planos').onclick = async () => {
      const r = await request('GET', '/api/gestor/planos')
      document.getElementById('pl-res').textContent = JSON.stringify(r.data)
      setStatus('Listar planos: ' + r.res.status, r.res.ok)
    }

    document.getElementById('btn-criar-prof').onclick = async () => {
      const go = document.getElementById('chk-prof').checked
      if (!go) { document.getElementById('prof-res').textContent = 'Marcado?'; return }
      const r = await request('POST', '/api/gestor/professor')
      document.getElementById('prof-res').textContent = JSON.stringify(r.data)
      setStatus('Criar professor: ' + r.res.status, r.res.ok)
    }

    document.getElementById('btn-checkout').onclick = async () => {
      const tier = document.getElementById('chk-tier').value
      const r = await request('POST', '/api/gestor/checkout', { tier })
      const u = r?.data?.url || null
      document.getElementById('chk-res').innerHTML = u ? ('URL: <a href="' + u + '" target="_blank">Abrir checkout</a>') : JSON.stringify(r.data)
      setStatus('Checkout: ' + r.res.status, r.res.ok)
    }
  </script>
</body>
</html>